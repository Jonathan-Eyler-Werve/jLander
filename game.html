<!-- file://localhost/Users/jonathan/gdrive/CODE/jLander/game.html -->

<html>
  <head>
    <title>jLander</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>

  <script type="application/javascript">
    var gameLoopCounter = 0;
    var frameRate = 30;
    var cycleTime = (1000 / frameRate);
    var landerSize = 10; // lander is a square
    var reboundRate = .99 // defines bounce decay; 1 is perfect rebound; .9 is "natural"
    var changeY = 0; // starting vertical velocity
    var changeX = 5; // starting horizontal velocity
    var posX  = 0; // starting horizontal position 
    var posY = 0; // starting vertical position
    var accelY = 1; // vertical forces at work!  
    var accelX = 0; // horizontal forces at work! 
    var drag = 0.9999; // atmosphere! ; 1 is no drag
    var thrust = 0; // dynamic thrust powers!
    var canvasEdgeY = 784; 
    var canvasEdgeX = 1440;
    var collisionCounter = 0; //always init to zero 




    $( document ).ready(function() {
      // key listeners 
      $( document ).keydown(function(event) {
        event.preventDefault();

        if ( event.which == 49 ) { // 1
          thrustOn("up", .1); 
        }
        else if ( event.which == 50) { // 2
          thrustOn("up", .2); 
        }
        else if ( event.which == 51) { // 3
          thrustOn("up", .3); 
        }
        else if ( event.which == 52) { // 4
          thrustOn("up", .4); 
        }
        else if ( event.which == 53) { // 5 
          thrustOn("up", .5); 
        };

      });
      $( document ).keyup(function(event) {
        event.preventDefault();
        thrustOff("up"); //any key! 
      });

    });


    function loop(){

      setInterval(function(){
        // console.log("loop starts. gameLoopCounter = " + gameLoopCounter);
        console.log("changeY = " + changeY)
        console.log("accelY = " + accelY)
        gameLoopCounter += 1; 
        changeX = (changeX + accelX) * drag;
        changeY = (changeY + accelY + thrust) * drag; 
        posX += changeX;
        posY += changeY;
        staticFriction(0.1);
        // console.log("positions updated to " + posX + " " + posY);
        collisionCheck();
        draw();
      },cycleTime);
    };


    function draw(){
      // console.log("draw starts")

      var canvas = document.getElementById("canvas");
      if (canvas.getContext) {

        var ctx = canvas.getContext("2d");
        ctx.clearRect (0, 0, canvasEdgeX, canvasEdgeY)
        ctx.fillStyle = "rgba(0, 255, 0, 1)";
        drawPosY = to_i(posY);
        drawPosX = to_i(posX);
        // console.log("drawing postions as " + drawPosX + " " + drawPosY)
        ctx.fillRect (drawPosX, drawPosY, landerSize, landerSize);

      }
      else {
        window.alert("You're too good looking to use a browser this old.");
      }  
    }

    function thrustOn(direction, percent) {
      if (direction == "up"){
        thrust = (-10 * percent);
        console.log("ThrustOn - " + direction + " " + percent )
      }
      else {
        console.log("ThrustOn lacks direction.")
        engineError();
      }    
    } 

    function thrustOff(direction){

      if (direction == "up") {
        thrust = 0
        console.log("ThrustOff - up")
      }
      else {
        console.log("ThrustOff lacks direction.")
        engineError();
      }    
    }

    function staticFriction(frictionDetect){
      if (collisionCounter < 3){
      }
      else {  
        changeY = 0;
        console.log("Static Y friction active")
      };

      if ( changeX > frictionDetect || changeX < (frictionDetect * -1) ){  
      }
      else {
        changeX = 0;
        console.log("Static X friction active")
      };
    };


    function collisionCheck(){
      // console.log("collisionCheck starts. collisionCounter = " + collisionCounter);

      if (posY > (canvasEdgeY - landerSize)) { // lower edge
        console.log("hit the bottom Y edge!");
        collisionCounter += 1;

        posY = (canvasEdgeY - landerSize);
        changeY = (changeY * reboundRate * -1)
        changeX = (changeX * reboundRate) 
      }
      else {
        collisionCounter = 0
      };

      if (posX > (canvasEdgeX - landerSize)) { // right edge
        console.log("hit the right Y edge!");
        posX = (canvasEdgeX - landerSize);
        changeX = (changeX * reboundRate * -1);
        changeY = (changeY * reboundRate); 
      };

      if (posY < 0) {                         // upper edge
        console.log("hit the top X edge!");
        posY = 0;
        changeY = (changeY * reboundRate * -1);
        changeX = (changeX * reboundRate);
      };

      if (posX < 0) {                         // left edge
        console.log("hit the left X edge!");
        posX = 0;
        changeX = (changeX * reboundRate * -1);
        changeY = (changeY * reboundRate);
      };
    };

   function to_i(_value) // uses Bitwise operator to convert to int - faster than Math methods
    {
     return _value | 0
    };


  </script>

    <style type="text/css">
      canvas { 
        border: 0px solid black; 
        background-color: black;
      }
    </style>
 
  </head>
 
  <body onload="loop();">
    <canvas id="canvas" width="1440" height="784"></canvas>
  </body>

</html>

